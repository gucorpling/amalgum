 1. IntroductionNowadays, distributed energy resources (DER) are leading the change in power generation as a result of the interest in renewable energy systems (RES) [1]. These DER could be connected to the utility grid or microgrids through three-phase voltage source converters (VSCs), consequently, the technical requirements, which must be accomplished by the power converter and its control algorithm, are growing [2].The trend in multifrequency control using vectorial complex theory [3] has increased the possible features. Among those possibilities, there is an useful one in power oscillations mitigation [4,5]. Nevertheless, the techniques and objectives fulfilled can vary in each application when dealing with unbalanced grids.Basically, if the active power oscillations are reduced in the VSC AC side, the low-frequency ripples in the DC-bus will decrease. Firstly, when low-frequency DC ripple currents flow through the DC-bus capacitor, the temperature of the passive component increases, which causes a decreasing lifetime of this component [6]. The batteries also suffer this problematic effect [7] and DC microgrids converters also look for reduced voltage oscillations due to power oscillations [8]. Secondly, the DC bus ripple voltage can have a harmful effect on the induction machine performance characteristics as torque pulsations [9]. Besides, on doubly fed induction generators (DFIGs) for wind turbines, active power oscillations are related to electromagnetic torque ripples that increase the mechanical stress on the turbine system [10].The harmonic power oscillations in three-phase three-wire AC electrical systems come from the presence of distorted or unbalanced grids. Therefore, the control strategy aims to regulate the instantaneous active power at a constant value by injecting the suitable currents into the grid. The current reference could be calculated by means of the active and reactive power theory, first introduced in Reference [11]. From that theory, many works have dealt with the regulation of active power oscillations when grid imbalances [12,13] or grid faults [14,15,16] are faced by the power converter. However, these methodologies only remove the second harmonic power ripple due to the appearance of fundamental negative sequence (FNS) voltage and its interaction with the fundamental positive sequence (FPS) current. In distorted grids, there are higher even harmonic power ripples due to other harmonic sequence voltages (−5, +7, −11, +13). Hence, an effective multifrequency current reference calculator is required by the algorithm to accomplish the power ripple removal.The presented control objective has an unavoidable characteristic in three-phase three-wire systems—the elimination of active power oscillations implies more reactive power fluctuations [13,16]. Previous publications such as References [17,18,19] claimed the elimination of both active and reactive power oscillations, simultaneously. However, this approach in three-wire systems leads to the injection of zero-sequence currents. Hence, the harmonic distortion in the injected current increases dramatically [18]. Even so, there are some works where this injection is regulated. In Reference [20], two control coefficients are added to control the injection of 3rd order current harmonics, that is, zero-sequence. Nevertheless, most case studies only consider positive and negative sequences because zero-sequence voltages of unbalanced voltage dips do not exist in three-wire systems, nor can they propagate to the secondary side of star-ungrounded or delta-connected transformers in four-wire systems [15]. Even for unbalanced systems with zero-sequence voltage, four-leg inverter topologies can eliminate zero-sequence current with appropriate control [21].The multifrequency current reference calculator purpose, just taking into account positive and negative sequences, has been partly fulfilled for DER applications [5] as well as DFIG ones [10,22]. Both proposals are defined in synchronous reference frames (SRF), hence, coordinate transformations are required. This implies online computation of trigonometric functions, which is usually performed through tables, increasing the memory requirements of the algorithm to get considerable accuracy. However, they are unnecessary because the current reference calculation can be directly implemented in the stationary reference frame (StRF), as Reference [23] has shown for unbalanced grids. However, the StRF approach has been unemployed for the multifrequency control of instantaneous power, which avoids redundant transformations for each one of the dealt harmonics. Besides, grid frequency variations are under the scope in recent years and grid frequency offset around its nominal values decreases the quality of injected currents [24]. Therefore, frequency-adaptive techniques [25] must be applied in order to accomplish the control objective of constant active power, as is shown in this paper.From the grid code operation point of view, the injected harmonic sequence currents are limited by the total harmonic distortion (THD) standards [26]. In order to achieve standards limitations, any of the harmonic sequence currents could be set to zero or current HD minimization could be performed [5]. Both approaches must sacrifice the cancellation of one power ripple component, and the smallest power ripple is chosen for the optimum performance. Therefore, the optimum current harmonics shaping is also applied in this proposal.The generated reference current must always be reachable, that is, overcurrent must be avoided under normal operation. The usual strategy is performed by limiting the current vector to the maximum RMS or peak values regardless of the harmonic components. This situation leads to undesired signal distortion, and it also avoids the required power ripple elimination. In Reference [27], which is a STATCOM application, the peak current is limited by defining the maximum reactive power that varies with the voltage characteristics and a control gain. Alernatively, in Reference [28], the injected current is safely controlled to a predefined maximum value by tuning active and reactive control gains. Other works [29,30] have also studied algorithms for peak current limitation, but, as with the previous one, they are focused on unbalanced voltage sags. The peak current limitation approach needs a solution where the vector trajectory is considered. Hence, the strategy presented in Reference [31] is a good starting point for the proposed maximum peak reference current saturator. However, that strategy deals with a high computational burden, which will be reduced in this approach.Summing up, this work avoids reference frame transformation to solve the system of linear equations, and the current reference is limited by the maximum peak current allowed per phase while adapting the whole algorithm to the grid frequency. Therefore, the proposed Current Reference Generator (CRG) is composed by the Current Reference Calculator (CRC) in StRF and Maximum Peak Current Saturator (MPCS), which are the contributions of this paper. The overall structure is presented in Figure 1. 2. Instantaneous Power Analysis in Stationary Reference FrameThis section addresses the theoretical analysis of the instantaneous power theory [32] for multifrequency environments. The theory is developed in StRF for a three-phase three-wire system, thus the zero-sequence

γ

 can be neglected. Therefore, the phase voltage and currents at the point of common coupling (PCC) are transformed by applying the Clarke transformation









x
α






x
β





=

1
3





2



−
1




−
1





0



3




3










x
a






x
b






x
c










(1)

where x can denote voltage or current and is function of time t. The notation as a function of time t of instantaneous variables is avoided for ease of readability. The instantaneous complex power


s
→


 is defined as follows





s
→

=

3
2




v
→


α
β





(


i
→


α
β


)

*

=

(
p
+
j
q
)






(2)

where p represents the instantaneous real power, and q represents the instantaneous imaginary power. Each electrical signal



x
→


α
β



 (voltage,



v
→


α
β



, or current,



i
→


α
β



) can be composed of different harmonic terms as






x
→


α
β


=

∑

h
∈

H
s





x
→


α
β


h


=

x
α

+
j

x
β






(3)

where


H
s


 is the set of the most usual harmonic sequences, that is,



H
s

=

[
…
,
−
11
,
−
5
,
−
1
,
+
1
,
+
7
,
+
13
,
…
]



. Once the basis is established, the following describes the mathematical approach on StRF multifrequency power analysis. By substituting voltage and current as expressed in (3) into (2), a sum of different products between voltage and current harmonics results. Hence, the phasorial expression of each addend is defined as follows






s
→

k

=

3
2




v
→


α
β



h
1







i
→


α
β



h
2





e

j

k

ω
1

t
+

ϕ

h
1


−

φ

h
2










(4)

where


h
1


 and


h
2


 denote the sequence harmonic of the studied voltage and current, respectively, and


k
=
(

h
1

−

h
2

)


, whereas


ϕ

h
1



 and


φ

h
2



 are the initial phases of each vector. The power phasor



s
→

k


 rotates at k times


ω
1


, that is, the FPS frequency. Therefore, three cases can be analyzed depending on the value of


h
1


 and


h
2


: no rotation; positive rotation; negative rotation. Hence, k denotes a positive or negative value that infers ripple over p and q.If



s
→

k


 induces power oscillations, the only way of achieving no active power oscillation is having the counterpart power phasor. There is no such solution without injecting zero-sequence, but the cancellation of the real or imaginary part is possible by generating the proper power phasor. It is the one produced by



v
→


α
β



h
2




 and



i
→


α
β



h
1




, that is,



s
→


−
k



. The sum of both power phasors will result in a power vector that is composed of two harmonic sequences


±
|
k
|


 as expressed in the following:









s
→


±
|
k
|


=






s
→


+
|
k
|




e

j


|
k
|


ω
1

t
+

Φ

+
|
k
|






︸



s
→


+
|
k
|



+






s
→


−
|
k
|




e

j

−

|
k
|


ω
1

t
+

Φ

−
|
k
|






︸



s
→


−
|
k
|















s
→


+
|
k
|



=

3
2


|



v
→


α
β



h
1




|
|



i
→


α
β



h
2




|









Φ

+
|
k
|


=

ϕ

h
1


−

φ

h
2











s
→


−
|
k
|



=

3
2


|



v
→


α
β



h
2




|
|



i
→


α
β



h
1




|









Φ

−
|
k
|


=

ϕ

h
2


−

φ

h
1













(5)

where


ϕ

h
2



 and


φ

h
1



 are the initial phases of the corresponding voltage and current vectors, respectively. Please note that two possible combinations are feasible between voltage and current harmonics depending on the sign of k. The previous definitions have been carried out considering


k
>
0


.Therefore, using real and imaginary parts of the voltage and current vectors, the corresponding real and imaginary parts of the power vector



s
→


±
|
k
|



 are





p

|
k
|


=




3
2


(

v

α


h
1



i

α


h
2


+

v

β


h
1



i

β


h
2


)


︸


ℜ
[


s
→


+
|
k
|


]


+




3
2


(

v

α


h
2



i

α


h
1


+

v

β


h
2



i

β


h
1


)


︸


ℜ
[


s
→


−
|
k
|


]
)







(6)







q

|
k
|


=




3
2


(

v

β


h
1



i

α


h
2


−

v

α


h
1



i

β


h
2


)


︸


ℑ
[


s
→


+
|
k
|


]


+




3
2


(

v

β


h
2



i

α


h
1


−

v

α


h
2



i

β


h
1


)


︸


ℑ
[


s
→


−
|
k
|


]


.





(7)

As first approach, one could be tempted to directly setting (6) and (7) to zero in order to find the set of four linear equations (considering the other two linear equations related to the power when


k
=
0


) that gives the required current reference. However, if (5) is set to zero, it is proven that only the real or imaginary part can be set to zero. Two variables with opposite sequence cannot cancel each other. The unique solution taking into account negative and positive sequences is zero FPS current, which is unfeasible for power converter operation.Consequently, considering that just the active (real) or reactive (imaginary) power ripple can be set to zero, a new approach must be taken to find the set of linear equations that allow us to define the proper harmonic currents.In order to obtain zero



|
k
|


t
h



 harmonic active power ripple, that is,



p

|
k
|


=
0


 being


k
≠
0


, one of the following conditions must be fulfilled:









s
→


p

|
k
|



=


s
→


+
|
k
|


+


(


s
→


−
|
k
|


)



*


=
0








(8a)











s
→


p

|
k
|



=


(


s
→


+
|
k
|


)



*


+


s
→


−
|
k
|


=
0








(8b)

where



s
→


p

|
k
|




 is a new variable that makes reference to this condition.On account of the real-valued nature of the variable


p

|
k
|



, its sinusoidal behavior elimination has two possible solutions in the complex plane, that is, the variable


p

|
k
|



 could be the real part of a vector



s
→


p

|
k
|




 that apparently rotates with positive or negative frequency. Obviously, the reactive power ripple will inevitably increase. A graphical representation of (8a) is shown in Figure 2a, where each addend of



s
→


±
|
k
|



 is depicted independently for better understanding of the cancellation. Initially, we have



s
→


+
|
k
|



 (blue) and



s
→


−
|
k
|



 (dashed red), which have opposite sequences. Then, the complex conjugate of



s
→


−
|
k
|



 is depicted (purple), where is clearly noted that the real part related to active power oscillation has been canceled. Now, the addends rotate in the same direction, thus there is a feasible solution to that constraint. Note that the imaginary part of



s
→


p

|
k
|




 has helped us to define the set of linear equations, that is, it is just the quadrature of


p

|
k
|



 and it has no meaning over the electrical circuit.If we take back the notation using real and imaginary parts of the voltage and current vectors, the new linear equations are found. The condition (8a) is rewritten as




ℜ

[


s
→


p

|
k
|



]

=

3
2


(

v

α


h
1



i

α


h
2


+

v

β


h
1



i

β


h
2


+

v

α


h
2



i

α


h
1


+

v

β


h
2



i

β


h
1


)

=
0





(9)






ℑ

[


s
→


p

|
k
|



]

=

3
2


(

v

β


h
1



i

α


h
2


−

v

α


h
1



i

β


h
2


−

v

β


h
2



i

α


h
1


+

v

α


h
2



i

β


h
1


)

=
0
.





(10)

Please note that (9) and (10) could be composed of more than two harmonic orders because different combinations of voltage and current harmonics could contribute to the same



s
→


±
|
k
|



. Besides, if it is desired,



s
→


p

|
k
|




 can be set to a proper value different from zero and these equations are still valid.Alternatively, in order to obtain zero



|
k
|


t
h



 harmonic reactive power ripple, that is,



q

|
k
|


=
0


 being


k
≠
0


, one of the following conditions must be fulfilled:









s
→


q

|
k
|



=


s
→


+
|
k
|


−


(


s
→


−
|
k
|


)



*


=
0








(11a)











s
→


q

|
k
|



=
−


(


s
→


+
|
k
|


)



*


+


s
→


−
|
k
|


=
0








(11b)

where



s
→


q

|
k
|




 is a new variable that makes reference to this condition. A graphical representation of (11a) is shown in Figure 2b, where the negation of the complex conjugate of



s
→


−
|
k
|



 leads to the cancellation of the imaginary part. Now, the addends rotate in the same direction, thus there is a feasible solution to that constraint. If (11a) or (11b) are accomplished, the active power ripple will inevitably increase. Again, note that the real part of



s
→


q

|
k
|




 is just the quadrature of


q

|
k
|



.Finally, the linear equations that define the power calculation including no rotating real and imaginary power, P and Q, respectively, and using (9) and (10), are as follows








P




Q





ℜ
[


s
→


p

|
k
|



]






ℑ
[


s
→


p

|
k
|



]






ℜ
[


s
→


q

|
k
|



]






ℑ
[


s
→


q

|
k
|



]





=

3
2






v

α


h
1





v

β


h
1





v

α


h
2





v

β


h
2







v

β


h
1





−

v

α


h
1






v

β


h
2





−

v

α


h
2








v

α


h
2





v

β


h
2





v

α


h
1





v

β


h
1







−

v

β


h
2






v

α


h
2





v

β


h
1





−

v

α


h
1








v

α


h
2





v

β


h
2





−

v

α


h
1






−

v

β


h
1








v

β


h
2





−

v

α


h
2






v

β


h
1





−

v

α


h
1












i

α


h
1







i

β


h
1







i

α


h
2







i

β


h
2






.





(12)

Please note that the set of linear equations in StRF is similar to the one proposed in SRF in previous works [4,5,10]. Therefore, this deduction proves that there is no need of performing a reference transformation for every harmonic sequence. The deduction seems trivial, but to the authors’ knowledge, this approach has never been proposed before. Once the set of linear equations is properly composed and the objective active and reactive powers are defined using the proposal on this work, the solution at each time step will be the current reference. However, this signal must be limited before it is sent to the current controller to avoid overcurrent. 3. Current Reference SaturatorsThe command signal must be kept below the protection threshold by defining an absolute value


I

S
A
T



. Typically, this value is set above the nominal value, but below the protection one.The current reference in this case is composed of different harmonic sequences, that is, the vector trajectory is not a circumference and there is not a direct correspondence between RMS current and maximum amplitude per phase. In this situation, the phase current could exceed RMS value or the maximum amplitude independently. The maximum module current saturator, which is related to the RMS value of the signal, is a well-known solution and it is presented in this paper for comparative purposes. The MPCS is the second contribution of this paper, and it maximizes the control objective by taking advantage of the hexagonal limits of the current vector in the complex plane. 3.1. Maximum Module Current SaturatorThe module of a multifrequency reference current vector (Clarke transformation) is






I

r
e
f



=



∑

h
∈

H
s






i

α


r
e
f
,
h



2

+



i

β


r
e
f
,
h



2



.





(13)

If this value exceeds the saturation threshold, every harmonic sequence is reduced in magnitude by a proper gain. The phase of each harmonic sequence is kept constant. In order to remove the power oscillations, that is, to keep the proposed control objective, all harmonic sequences must be equally reduced. Then, the saturation gain is calculated as





k
S

=


I

S
A
T





∑

h
∈

H
s






i

α


r
e
f
,
h



2

+



i

β


r
e
f
,
h



2




.





(14)

where


I

S
A
T



 is the threshold value. Then, if


k
S


 is higher than or equal to 1, the reference current is below the saturation limit. Else, each reference harmonic sequence is multiplied by this gain. Clearly, this solution is always considering a circumferential trajectory and it is not taking advantage of the three-phase current signal trajectory. This saturation technique is denominated as circular limit method (CL) in the literature for voltage saturators [33]. Besides, in order to avoid signal clipping, the signal trajectory must be analyzed. Therefore, the appropriate approach when dealing with multifrequency harmonic signals is an instantaneous maximum peak value saturator that analyzes it. 3.2. Maximum Peak Current Saturator (MPCS)The aim of this algorithm is to avoid that any instantaneous reference current per phase is beyond the saturation value and this is the second contribution of this paper. The saturation hexagon, as depicted in Figure 3a, is defined in the StRF using (1).If the current reference is composed of several sequence harmonics as defined in (3), the signal trajectory is no longer a circumference and it needs to be contained inside the hexagon. Figure 3b depicts how the proposal of this section does not distort the signal whereas the maximum module saturator shows a signal clipping, that is, distortion. Therefore, the saturation technique has to analyze the signal’s trajectory, as presented in the following.The trajectory of the vector



i
→


α
β


r
e
f



 is described as the geometric place of all its points during a complete FPS period. There are two possibilities for analyzing the trajectory: taking past samples or extrapolating them. In the following, the second one is explained because the first is directly deduced from this explanation. A



i
→


α
β


r
e
f



 sample could be inside or outside of the hexagon, but nothing is known about the following ones. An example of full trajectory is depicted in Figure 4a, where some points might be outside and others inside the hexagon. Therefore, the extrapolated trajectory is described by taking into account the harmonic sequence decomposition at the present sample, and considering no magnitude (


I
h


) nor phase (


φ
h


) variation for each harmonic h.In order to keep null power oscillation, the same saturation gain



k
S

∈
R
:
0
<

k
S

<
1


 is applied to all



i
→


α
β


r
e
f
,
h



. Hence, the saturated trajectory,



i
→


α
β


r
e
f
,
s



, is described as






i
→


α
β


r
e
f
,
s


=

k
S


∑

h
∈

H
s




I
h


(
cos

(
h

ω
1

t
+

φ
h

)

+
j
sin

(
h

ω
1

t
+

φ
h

)

)

.





(15)

Geometrically, in a


R
2


 plane, (15) can be parameterized as







x
=

k
S


∑

h
∈

H
s




I
h

cos

(
h

ω
1

t
+

φ
h

)









(16a)









y
=

k
S


∑

h
∈

H
s




I
h

sin

(
h

ω
1

t
+

φ
h

)

.








(16b)

Then, the problem can be easily solved following these facts—(1) The hexagon and the vector trajectory have odd symmetry, so just half-trajectory is necessary, as shown in Figure 4b; (2) Due to the geometrical properties of the hexagon, the edges can be interpreted as constant functions that are equal to the hexagon apothem



x

m
a
x


=
±

I

S
A
T




.The first statement is straightforward from the properties of vectorial variables. The second fact is proven by reducing the problem to dimension x (16a) and comparing with the left and right edges (


±

I

S
A
T




). These edges are always parallel to the y-axis as in Figure 4c. The other four edges are just


±

60
∘



 rotations of left and right edges around the origin. The same effect is obtained by keeping static the edges, and the trajectory is the one that rotates as in both Figure 4d and Figure 4e. The whole comparison is accomplished as three independent ones, as it can be composed in Figure 4f. Therefore, rearranging (16a) in order to apply the rotations



ϕ
r

=

[

0
∘

,
+

60
∘

,
−

60
∘

]



, the gain at every sample is solved from




±

I

S
A
T


=

k
S


∑

h
∈

H
s




[

I
h
C

cos

(
h
n

ω
1


T
s

)

−

I
h
S

sin

(
h
n

ω
1


T
s

)

]






(17)

where the expression is in discrete-time (sample


n
∈
N


) and








I
h
C

=

I
h

cos

(

φ
h

+

ϕ
r

)

=

I

α
,
h


cos

(

ϕ
r

)

−

I

β
,
h


sin

(

ϕ
r

)








I
h
S

=

I
h

sin

(

φ
h

+

ϕ
r

)

=

I

β
,
h


cos

(

ϕ
r

)

+

I

α
,
h


sin

(

ϕ
r

)

.









Note that


I

α
h



 and


I

β
h



 are the real and imaginary parts of every



i
→


α
β


r
e
f
,
h



 at the sample under study, that is, the present values that are used for extrapolation.Finally, the minimum


k
S


, which is obtained by solving (17) for each extrapolated sample, would be chosen as it would represent the most limiting scenario. The input and output of the MPCS are shown in Figure 4g. This approach would reach the steady-state as soon as the system under control has reached it. However, the main drawback of this approach is the computation time. The signal extrapolation increases the computational burden because several trigonometric operations would be required. Therefore, a more time-efficient approach would use a trajectory analyzer of the last half period of FPS, that is, it uses the minimum gain


k
S


 over this time span. Hence, steady-state could be reached at most half period of FPS later than the system under control.The trajectory analyzer of past samples is a low computation burden solution, which simplifies the implementation of the MPCS. Besides, the case under study requires that the saturation gain


k
S


 must be equally applied to all harmonic sequences, so the algorithm is even more simplified, see Algorithm 1.Algorithm 1 Maximum peak reference current saturator (MPCS)Input: Present sample:


I

α


r
e
f



,


I

β


r
e
f



;


s
a
m
p
l
e
s
=
[
1
/

(

f
1

·
T
s
·
2
)

]


; Array of past gains:


k
s
[
s
a
m
p
l
e
s
+
1
]


Output: Saturated present sample:


I

α


r
e
f
,
s



,


I

β


r
e
f
,
s



; Array of gains:


k
s
[
s
a
m
p
l
e
s
+
1
]


 1: Initialization :


k
D
e
n
R
o
t
=
1


;


n
e
w
D
E
N
=
1


;


k
s
p
=
1


 2: for each rotation:


r
o
t
=
{
−
1
,
0
,
1
}


 do 3: if (


r
o
t
=
0


) then 4:  


n
e
w
D
e
n
=

I

α


r
e
f




 5: else 6:  


n
e
w
D
E
N
=

I

α


r
e
f


·
c
o
s

(

60
∘

)

·
a
b
s

(
r
o
t
)

−

I

β


r
e
f


·
s
i
n

(

60
∘

)

·
r
o
t


 7: end if 8: if (


k
D
e
n
R
o
t
<
a
b
s
(
n
e
w
D
e
n
)


) then 9:  


k
D
e
n
R
o
t
=
a
b
s
(
n
e
w
D
e
n
)


10: end if11: end for12:


k
s

[
1
]

=

I

S
A
T


/
k
D
e
n
R
o
t


13: for each sample:


k
=
s
a
m
p
l
e
s
+
1


 to 2 do14: 


k
s
[
k
]
=
k
s
[
k
−
1
]


15: if (


k
s
[
k
]
<
k
s
p


) then16:  


k
s
p
=
k
s
[
k
]


17: end if18: end for19:



I

α


r
e
f
,
s


=
k
s
p
·

I

α


r
e
f




20:



I

β


r
e
f
,
s


=
k
s
p
·

I

β


r
e
f




In conclusion, this approach has two improvements over the usual multifrequency saturators—(1) It takes advantage of the hexagonal shape in order to maximize the control objective when dealing with multifrequency signals; (2) It does not distort the signal because the signal’s trajectory is analyzed. The second feature is clearly seen in the steady state representation of Figure 3b, because the maximum module saturator clips the signal. Besides, the MPCS works during frequency variations because the gain array size is set to the maximum possible considering the minimum FPS. Usually, the frequency variations are up to


2
%


 around the nominal value, which is translated into two samples more for a sample time of


200

μ
s


. 4. Instantaneous Power ControlIn order to accomplish the control objective, a multifrequency current controller is employed for tracking the most common sequences in distorted grids



H
s

=

[
+
1
,
−
1
,
−
5
,
+
7
]



. As it is shown in Figure 1, the control is divided in three steps—(1) PCC voltage sequence harmonic detection (SHD); (2) Current reference generator (CRG); (3) Current controller. Besides, the control scheme also counts with a PLL to get a frequency-adaptive solution. It is well-known that frequency variations produce THD degradation [24] which avoids the control objective achievement, that is, null active power oscillations. 4.1. Frequency Estimation and ImplementationThe FPS,



ω
^

1


, is extracted by a PLL algorithm, which is conveniently tuned to remove the fluctuation in frequency under harmonically distorted environments [25]. Besides, the PLL input is the FPS PCC voltage once it has been filtered by means of the SHD. The PLL constants are collected in Table 1.The frequency adaptation affects the SHD and the current controller and it requires the online computation of exponential functions in each ROGI, that is, trigonometric functions which are usually performed using tables. These tables imply increasing memory requirements in order to get more accuracy. In contrast, the first-order Taylor series expansion of the exponential functions around


ω
1


 [24] is a more accurate solution. It is defined as





e

j
h


ω
^

1


T
s



≃

e

j
h

ω
1


T
s




(
1
+
j
h

(


ω
^

1

−

ω
1

)


T
s

)

.





(18)

 4.2. Sequence Harmonic Detection (SHD)The harmonic sequences



H
s

=

[
−
1
,
+
1
,
−
5
,
+
7
]



 that appear in the grid voltage at the PCC need to be successfully detected. For that purpose, a system based on multiple ROGI (Reduced Order Generalized Integrator) has been employed [34]. The PCC voltage



v
→


α
β



, as reference, is compared with the sum of detected sequences



v
→


α
β


D
E
T



, so each ROGI


R

α
β

h


 reduces the error at the tuned frequency


h


ω
^

1



. Therefore, the output of each ROGI is the corresponding harmonic sequence. The open-loop transfer function is defined as








v
→


α
β


D
E
T



(
z
)





v
→


α
β



(
z
)

−


v
→


α
β


D
E
T



(
z
)



=

G

α
β


O
L
−
S
E
Q



(
z
)

=

∑

h
∈

H
s







k
h
s


z
−

e

j
h


ω
^

1


T
s





︸



R

α
β

h


(
z
)








(19)

where


k
h
s


 is the integration gain which determines the ROGI response in terms of settling time and over impulse. Then, the detected harmonic sequences



v
→


α
β

h


 are the outputs of each ROGI


R

α
β

h


, and the closed loop response for each one would be






v
→


α
β

h


(
z
)

=


R

α
β

h


1
+

G

α
β


O
L
−
S
E
Q



(
z
)





v
→


α
β



(
z
)

.





(20)

Finally, note that the frequency-adaptive feature is added to the structure for accurate filtering. The selected gain values are provided in Table 1. 4.3. Current Reference Calculation (CRC)The instantaneous power analysis carried out in Section 2 is now particularized for the set of studied harmonics


H
s


. Consequently, the instantaneous power is defined by a constant value and even order harmonics of FPS (2, 4, 6, 8, 12). Four harmonic sequence currents can be controlled, thus the calculation just set value to the constant power P, Q and the lowest frequency active power ripple


p
2


,


p
4


, and


p
6


. The set of 8 linear equations to be solved is as follows




S
=

3
2

V
I





(21)

where





S
T

=




P


Q



ℜ
[


s
→


p
2


]




ℑ
[


s
→


p
2


]




ℜ
[


s
→


p
4


]




ℑ
[


s
→


p
4


]




ℜ
[


s
→


p
6


]




ℑ
[


s
→


p
6


]
















V
=





v

α


+
1





v

β


+
1





v

α


−
1





v

β


−
1





v

α

5




v

β

5




v

α

7




v

β

7






v

β


+
1





−

v

α


+
1






v

β


−
1





−

v

α


−
1






v

β

5




−

v

α

5





v

β

7




−

v

α

7







v

α


−
1





v

β


−
1





v

α


+
1





v

β


+
1




0


0


0


0





−

v

β


−
1






v

α


−
1





v

β


+
1





−

v

α


+
1





0


0


0


0




0


0



v

α

5




v

β

5




v

α


−
1





v

β


−
1




0


0




0


0



−

v

β

5





v

α

5




v

β


−
1





−

v

α


−
1





0


0






v

α

5

+

v

α

7






v

β

5

+

v

β

7




0


0



v

α


+
1





v

β


+
1





v

α


+
1





v

β


+
1








v

β

7

−

v

β

5






v

α

5

−

v

α

7




0


0



v

β


+
1





−

v

α


+
1






−

v

β


+
1






v

α


+
1


















I
T

=





i

α


+
1





i

β


+
1





i

α


−
1





i

β


−
1





i

α


−
5





i

β


−
5





i

α


+
7





i

β


+
7






.






The standards [26] penalize the injection of harmonic current sequences, then it is highly recommended to follow the Harmonic Distortion (HD) optimization presented in Reference [5]. The level of reference current distortion is given by the active power harmonics that must be set to zero and the most relevant ones are provoked by the FPS (i.e., 2 and 6). Then, the negligible active power ripple


p
4


 condition in (21) is released and the available degree of freedom is employed to minimize the HD current. The target function to be minimized is




H
D
=


(

i

α


−
5


)

2

+


(

i

β


−
5


)

2

+


(

i

α


+
7


)

2

+


(

i

β


+
7


)

2

.





(22)

Each variable can be expressed as





i
m

o
p
t


=

a
m

+

b
m


i

α


+
1


+

c
m


i

β


+
1







(23)

where m indicates the row number of the following matrices








I

o
p
t


=
I

[
3
,
8
;
1
]






S

o
p
t


=





S
[
1
,
4
;
1
]






S
[
7
,
8
;
1
]























A
=

2
3


M

−
1



S

o
p
t






B
=
−

M

−
1



M
b





C
=
−

M

−
1



M
c








M
b

=
V

[
1
,
8
;
1
]






M
c

=
V

[
1
,
8
;
2
]





M
=





V
[
1
,
4
;
3
,
8
]






V
[
7
,
8
;
3
,
8
]









.






We use


X
[

i
1

,

i
2

;

j
1

,

j
2

]


 to denote the submatrix of X consisting of the intersection of rows


i
1


 through


i
2


 and columns


j
1


 through


j
2


. Finally, substituting (23) into (22), the partial derivatives are easily worked out in order to find the minimum value and the following equality must hold













∑

m
=
3

6


2

b
m


a
m









∑

m
=
3

6


2

c
m


a
m






︸

D

=









∑

m
=
3

6


2

b
m
2







∑

m
=
3

6


2

b
m


c
m





0

1
×
6









∑

m
=
3

6


2

b
m


c
m







∑

m
=
3

6


2

c
m
2





0

1
×
6






︸

E

I
.





(24)

Finally, the new set of linear equations is





S

o
p
t


=

3
2


V

o
p
t


I





(25)

where








S

o
p
t

T

=




P


Q



ℜ
[


s
→


p
2


]




ℑ
[


s
→


p
2


]




D
T




ℜ
[


s
→


p
6


]




ℑ
[


s
→


p
6


]












V

o
p
t


=





V
[
1
,
4
;
1
,
8
]





E





V
[
7
,
8
;
1
,
8
]





.









 4.4. Current ControllerThe selected current control structure is depicted in Figure 5, which is basically a multi-resonator at the frequencies of interest. The plant model is discretized by applying a Zero-Order Hold (ZOH), so the half sample delay from the PWM dynamics is already included. The one sample computational delay induced by the digital controller actuation voltage is also included as a state. In conclusion, the augmented plant can be expressed in state-space form as




x
(
k
+
1
)
=
A
x
(
k
)
+
B
u
(
k
)





(26)

where










A
=




b


a


0


0


0


0




0


0


0


0


0


0




1


0



e

j


ω
^

1


T
s





0


0


0




1


0


0



e

−
j


ω
^

1


T
s





0


0




1


0


0


0



e

−
j
5


ω
^

1


T
s





0




1


0


0


0


0



e

j
7


ω
^

1


T
s











B
=




0




1




0




0




0




0













x

(
k
)

=






i
→





u
→



d






r
→



+
1






r
→



−
1






r
→



−
5






r
→



+
7






T










defining


b
=

e

−

R
f


T
s

/

L
f





 and


a
=

(
1
−
b
)

/

R
f



. A state-feedback approach is taken here using a Linear Quadratic Regulator (LQR) strategy. The weighting matrices Q and R determine the relative importance of the state error and energy expenditure. Their values have been chosen according to the guidelines presented for a VSC in Reference [35], considering that overmodulation would be avoided. The weighting matrices Q and R in this paper are


Q
=
d
i
a
g






0.001



0



0.001




0.0001




0.0001




0.0001






,

R
=
0.1


.The feedback law is


u
(
k
)
=
−
L
x
(
k
)


, being


L
=





k
p




k
b




k

+
1





k

−
1





k

−
5





k

+
7








. The gains are provided in Table 1. 5. Simulation ResultsThe system under analysis, briefly described in Figure 1, has been simulated using Matlab 2018b. A 100 kVA three-level Neutral Point Clamped (NPC) VSC is employed, and it is connected to an unbalanced and distorted grid through an L filter (Table 2). The grid impedance, that is,


L
g


 and


R
g


, is neglected. Besides, there are two capacitors of 4.5 mF in the DC-bus. Note that the digital controller is working in double-update. The simulation is a VSC working as a STATCOM, which is required to deliver reactive capacitive power (



Q

r
e
f


=
26


 kVAr) while employing the active power exchange to control the DC-bus voltage. The operation as STATCOM let us clearly study the control objective because high current can be achieved and the instantaneous active power exchange is mainly related to active power oscillations. However, as stated in Section 1, this control proposal can be applied to DERs. First, the CRG performance is analyzed throughout 5 situations. Then, the frequency-adaptive solution is tested when the FPS is allowed a variation of


±
2
%


 around the nominal frequency.The presented simulation has been set up for 5 CRG situations, where the calculated current reference is beyond the specified saturation value (



I

S
A
T


=
50
A


) in order to notice the effectiveness of the MPCS in the first four cases, and what happens when it is not employed. The cases depicted in Figure 6 areGeneration of



i
→


α
β


r
e
f



 using a


2
×
2


 voltage matrix with



H
s

=

[
+
1
]



 for the requested P and Q. This is the base case that does not perform any active power ripple mitigation.Generation of



i
→


α
β


r
e
f



 using a


4
×
4


 voltage matrix with



H
s

=

[
−
1
,
+
1
]



 for the requested P, Q, and setting to zero


p
2


.Generation of



i
→


α
β


r
e
f



 using a


8
×
8


 voltage matrix with



H
s

=

[
−
5
,
−
1
,
+
1
,
+
7
]



 for the requested P, Q, and setting to zero


p
2


,


p
4


, and


p
6


.Generation of



i
→


α
β


r
e
f



 using a


8
×
8


 voltage matrix with



H
s

=

[
−
5
,
−
1
,
+
1
,
+
7
]



 for the requested P, Q, and setting to zero


p
2


, and


p
6


 by means of HD optimization.Equivalent to case 4, but there is no MPCS. The saturation technique takes the present sample and compares it with the hexagonal limits.The results are also collected in Table 3, where the lowest value for each harmonic among all cases are in bold. From the FFTs that are depicted in Figure 6, it can be noticed how the power ripple is effectively reduced when the proper current is injected at the PCC. Although the power ripple is eliminated in case 3 (Figure 6c), according to Reference [26], the individual odd HD below 11th harmonic must always be lower than 4%. Hence, when the optimization algorithm is applied, the harmonic distortion is minimized while avoiding power oscillations. Then, these results prove that the reference current can be directly calculated in the StRF. The last case shows that, when MPCS is not used, the steady state current will be composed of undesired harmonics. The corresponding HD value has been underlined in Table 3 to note that it is over the maximum allowed. The power ripple elimination will be inevitably worse because the injected current harmonics are not the proposed ones.The relationship between active power ripple in Figure 6a, and DC voltage in Figure 6b is well-established. The DC-bus capacitor size leads to low DC voltage ripple. However, we must note that the capacitor size for STATCOM applications is usually bigger than the one for DERs [20]. Therefore, the problematic is more measurable in DERs.The performance of the MPCS is depicted in Figure 7. The saturation strategy changes from MPCS to one that only takes the present sample at 50 ms. After that instant, the signal is clipped, and THD increases, hence, non-desired harmonic sequences appear in the injected current at the PCC, see Table 3. Please note that the signal trajectory in Figure 7c is almost circular, which is circumstantial for the case under analysis due to HD minimization.Lastly, the frequency-adaptive results are shown in Figure 8. The frequency is accurately estimated, see Figure 8b, until 150 ms, then the strategy is forced to follow the nominal FPS. Once the system is not following the actual frequency, there is a signal distortion, hence, the control objective is not achieved and the active power oscillates. 6. Experimental ResultsThe proposed algorithm has been experimentally validated with its implementation by means of DSP TMS320C6713 DSK at 225 MHz (4.44-ns cycle time) [36]. The system was tested over an NPC converter with the specifications of Table 2. An unbalanced and distorted grid is generated by the programmable power supply Regatron TC.ACS [37]. Devices are depicted in Figure 9. The data is collected by a scope Yokogawa DL850 [38]. In order to keep safe the programmable power supply, the specified saturation value is set to



I

S
A
T


=
50
A


.The system is configured to perform five CRG cases (2 × 2, 4 × 4, 8 × 8, 8 × 8 Opt. and 8 × 8 Opt. with no MPCS). The required computation times, which increase with the complexity of the linear equations, are collected in Table 4. The computation times are similar to [5], but this proposal includes the current reference saturator while avoiding any transformation into SRF and using a frequency-adaptive scheme. The MPCS takes


2.5

μ


s to compute, so the computation difference comes from that additional algorithm. Besides, the DSP is not ready for performing dense linear algebra computations, i.e., it does not support DSP libraries as LINALG. Please note that coding strategy and processor are the same as [5].The generated unbalanced and distorted grid voltages are described in the following. The fundamental value of phase B has been set to 223


V

r
m
s



 generating unbalance to produce negative fundamental sequence. Besides, the −5 and 7 harmonics have been set to 9.2


V

r
m
s



 (


4
%


) and 4.6


V

r
m
s



 (


2
%


).The results are collected in Table 5 and are represented in Figure 10a along with the FFT of the injected currents in Figure 10b. The lowest value for each harmonic among all cases are in bold. When employing a


2
×
2


 matrix for the CRG, 2nd and 6th harmonics appear, due to unbalance and distortion, respectively. Then, by employing the


4
×
4


 matrix, second harmonic is reduced by means of the injection of FNS currents at the PCC. Therefore, when


8
×
8


 matrix or its optimized version are applied, the 6th is drastically reduced. The 4th harmonic is negligible in all of them. The injection of −5 and 7 current harmonics is optimized with the


8
×
8


 Opt CRG in order to obtain the same power oscillation results as its non-optimized counterpart. Although the THD in the optimized test is according to the standards (Table 5), there exists more distorted or unbalanced environments where the distortion can avoid the system workability.Figure 11 shows the experimental test from simulation in Figure 7. The figure zooms in the period when MPCS is employed (a), and when it is not (b). It proves how the harmonic distortion increases when the MPCS is not operating with past samples. The corresponding HD value has been underlined in Table 5 to note that it is over the maximum allowed. The harmonic active power does not increase a lot in the case under study, but the HD optimization has been wasted. Therefore, the application requires the MPCS to be correctly addressed.Finally, the frequency-adaptive test is shown in Figure 12. The figure zooms in the period when transition from 50 Hz to 51 Hz occurs (a), and when frequency adaptive scheme is removed. First, the result shows how the control system is able to adapt itself when the frequency is suddenly changed without difficulties. Then, the adaptation is removed and the system is tuned again to the nominal FPS, so the active power oscillates. 7. ConclusionsThe proposed multifrequency current reference calculation has resulted in an algorithm that takes the correct approach regarding previous proposals and avoids unnecessary computations. The presented current reference saturator has been proved as the correct selection when dealing with harmonic currents. The proposed MPCS could be useful for other applications, for example, VSC-based three-phase active power filters. The reference frame changes are avoided due to the lack of accuracy of trigonometric operations in DSPs using lookup tables without enough values. Besides, the novel approach in StRF gives an interesting insight into mutlifrequency instantaneous power theory. Although it could be a trivial solution due to its similarity to the one in SRF, no previous record of the presented deduction and proposal in StRF has been found in the literature. These two contributions have been implemented, tested and compared in terms of efficiency and computation time with a previous proposal. The simulated and experimental results have shown a performance improvement.References
